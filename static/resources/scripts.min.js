function startScript(){graphInterval=null,waveInterval=null,emoticonInterval=null,mainInterval=null,timeInterval=1e3,waveTime=100,gtimeSuffix=" sec",happySum=0,sadSum=0,normalSum=0,angrySum=0,sum=0,analysisFlag=!1,ehappySum=0,esadSum=0,enormalSum=0,eangrySum=0,esum=0,session=0,ctx3=null,ctx4=null,ctx5=null,ctx6=null,happyCall=null,sadCall=null,normalCall=null,angryCall=null,audioInput=null,audio_context=null,recorder=null,send=0,receive=0,micTimeout=null,progressFlag=!1,estimatedTime=0,netDelay=0,ltime=0,timeSpent=0,sec=0,loadGoogleAPIs();var e=$("html, body");$(".anchors").click(function(){var a=$.attr(this,"href");return e.animate({scrollTop:$(a).offset().top},500,function(){}),!1}),$("#completionAlert").hide(),emotionCanvas=document.getElementById("emotionCanvas"),waveFormCanvas=document.getElementById("waveFormCanvas"),ctx1=emotionCanvas.getContext("2d"),ctx2=waveFormCanvas.getContext("2d"),overallHappyCanvas=document.getElementById("overallHappyCanvas"),ctx3=overallHappyCanvas.getContext("2d"),overallSadCanvas=document.getElementById("overallSadCanvas"),ctx4=overallSadCanvas.getContext("2d"),overallNormalCanvas=document.getElementById("overallNormalCanvas"),ctx5=overallNormalCanvas.getContext("2d"),overallAngryCanvas=document.getElementById("overallAngryCanvas"),ctx6=overallAngryCanvas.getContext("2d"),overallCanvasInitilizer(),waveCanvasInitilizer(),barCanvasInitilizer()}function loadGoogleAPIs(){ctimeInterval=timeInterval,google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(initialChart),overallChartInterval=null,happyChartInterval=null,sadChartInterval=null,normalChartInterval=null,angryChartInterval=null}function overallCanvasInitilizer(){ctx3.clearRect(0,0,overallHappyCanvas.width,overallHappyCanvas.height),ctx4.clearRect(0,0,overallSadCanvas.width,overallSadCanvas.height),ctx5.clearRect(0,0,overallNormalCanvas.width,overallNormalCanvas.height),ctx6.clearRect(0,0,overallAngryCanvas.width,overallAngryCanvas.height),circularProgress(overallHappyCanvas,ctx3,0,"#337ab7"),circularProgress(overallSadCanvas,ctx4,0,"#FFAB40"),circularProgress(overallNormalCanvas,ctx5,0,"#03A9F4"),circularProgress(overallAngryCanvas,ctx6,0,"#D32F2F")}function waveCanvasInitilizer(){initialWaveForm(ctx2,waveFormCanvas)}function barCanvasInitilizer(){var e=new BarGraph(ctx1);e.maxValue=1,e.margin=2,e.colors=["#337ab7","#FFAB40","#03A9F4","#D32F2F"],e.xAxisLabelArr=["Happy","Sad","Normal","Angry"],e.update([0,0,0,0])}function startAnalysis(){if(1==analysisFlag)$(document).ready(function(){$("#warningModal").modal()});else{analysisFlag=!0,document.getElementById("mic_icon1").style.visibility="collapse",document.getElementById("start_btn").style.visibility="collapse",document.getElementById("mic_icon2").style.visibility="visible",document.getElementById("stop_btn").style.visibility="visible",happyChart(),sadChart(),normalChart(),angryChart(),overallChart(),overallCanvasInitilizer(),$("#completionAlert").hide(),$("#errorAlert").hide(),graph=new BarGraph(ctx1),graph.margin=2,graph.colors=["#337ab7","#FFAB40","#03A9F4","#D32F2F"],graph.xAxisLabelArr=["Happy","Sad","Normal","Angry"],wave=new waveForm(ctx2,waveFormCanvas),waveInterval=setInterval(function(){wave.oldWave(Math.random())},waveTime),happyCall=new happyChart,sadCall=new sadChart,normalCall=new normalChart,angryCall=new angryChart,overallCall=new overallChart,session++;var e=document.getElementById("dataTable"),a=e.insertRow(0),t=a.insertCell(0);t.innerHTML="Session: "+session,a=e.insertRow(1),t=a.insertCell(0),cell2=a.insertCell(1),cell3=a.insertCell(2),cell4=a.insertCell(3),cell5=a.insertCell(4),t.innerHTML="Time",cell2.innerHTML="Happy",cell3.innerHTML="Sad",cell4.innerHTML="Normal",cell5.innerHTML="Angry",sec=1,happySum=0,sadSum=0,normalSum=0,angrySum=0,startMicProcess()}}function startProcess(e,a,t,n,r){var l=e,o=a,i=t,s=n,m=dataTable.insertRow(sec+1),c=m.insertCell(0),d=m.insertCell(1),u=m.insertCell(2),v=m.insertCell(3),g=m.insertCell(4);c.innerHTML=r<60?r+"s":parseInt(r/60)+"m "+r%60+"s",d.innerHTML=l.toFixed(4),u.innerHTML=o.toFixed(4),v.innerHTML=i.toFixed(4),g.innerHTML=s.toFixed(4),sec++,happySum+=l,sadSum+=o,normalSum+=i,angrySum+=s,ehappySum=happySum,esadSum=sadSum,enormalSum=normalSum,eangrySum=angrySum,emoticonResponse(l,o,i,s),graph.maxValue=Math.max(10*l,10*o,10*i,10*s)+5,graph.update([10*l,10*o,10*i,10*s]),happyCall.happyChartCall(l,r),sadCall.sadChartCall(o,r),normalCall.normalChartCall(i,r),angryCall.angryChartCall(s,r),overallCall.overallChartCall(l,o,i,s,r)}function stopAnalysis(){document.getElementById("mic_icon2").style.visibility="collapse",document.getElementById("stop_btn").style.visibility="collapse",document.getElementById("mic_icon1").style.visibility="visible",document.getElementById("start_btn").style.visibility="visible",ctx2.clearRect(0,0,waveFormCanvas.width,waveFormCanvas.height),clearInterval(waveInterval),waveCanvasInitilizer(),stopMicProcess()}function stopProcess(){ctx1.clearRect(0,0,emotionCanvas.width,emotionCanvas.height),clearTimeout(graph.graphTimeout),document.getElementById("netDelay").innerHTML="NA",document.getElementById("estimatedTime").innerHTML="NA",$("#completionAlert").show(),clearAllTransitions(),ctx3.clearRect(0,0,overallHappyCanvas.width,overallHappyCanvas.height),ctx4.clearRect(0,0,overallSadCanvas.width,overallSadCanvas.height),ctx5.clearRect(0,0,overallNormalCanvas.width,overallNormalCanvas.height),ctx6.clearRect(0,0,overallAngryCanvas.width,overallAngryCanvas.height),overallEmotion(),barCanvasInitilizer()}function overallEmotion(){sum=happySum+sadSum+normalSum+angrySum;var e=Math.round(happySum/sum*100),a=Math.round(sadSum/sum*100),t=Math.round(normalSum/sum*100),n=Math.round(angrySum/sum*100),r=document.getElementById("dataTable"),l=r.insertRow(sec+1),o=l.insertCell(0),i=l.insertCell(1),s=l.insertCell(2),m=l.insertCell(3),c=l.insertCell(4);o.innerHTML="Total:",i.innerHTML=happySum.toFixed(4),s.innerHTML=sadSum.toFixed(4),m.innerHTML=normalSum.toFixed(4),c.innerHTML=angrySum.toFixed(4),l=r.insertRow(sec+2),o=l.insertCell(0),i=l.insertCell(1),s=l.insertCell(2),m=l.insertCell(3),c=l.insertCell(4),o.innerHTML="Percent:",i.innerHTML=e+"%",s.innerHTML=a+"%",m.innerHTML=t+"%",c.innerHTML=n+"%",circularProgress(overallHappyCanvas,ctx3,Math.round(happySum/sum*100),"#337ab7"),circularProgress(overallSadCanvas,ctx4,Math.round(sadSum/sum*100),"#FFAB40"),circularProgress(overallNormalCanvas,ctx5,Math.round(normalSum/sum*100),"#03A9F4"),circularProgress(overallAngryCanvas,ctx6,Math.round(angrySum/sum*100),"#D32F2F")}function estimatedEmotion(){ctx3.clearRect(0,0,overallHappyCanvas.width,overallHappyCanvas.height),ctx4.clearRect(0,0,overallSadCanvas.width,overallSadCanvas.height),ctx5.clearRect(0,0,overallNormalCanvas.width,overallNormalCanvas.height),ctx6.clearRect(0,0,overallAngryCanvas.width,overallAngryCanvas.height),esum=ehappySum+esadSum+enormalSum+eangrySum;Math.round(ehappySum/esum*100),Math.round(esadSum/esum*100),Math.round(enormalSum/esum*100),Math.round(eangrySum/esum*100);estimatedEmotionProgress(overallHappyCanvas,ctx3,Math.round(ehappySum/esum*100),"#337ab7"),estimatedEmotionProgress(overallSadCanvas,ctx4,Math.round(esadSum/esum*100),"#FFAB40"),estimatedEmotionProgress(overallNormalCanvas,ctx5,Math.round(enormalSum/esum*100),"#03A9F4"),estimatedEmotionProgress(overallAngryCanvas,ctx6,Math.round(eangrySum/esum*100),"#D32F2F")}function startMic(){window.AudioContext=window.AudioContext||window.webkitAudioContext,null==audio_context?(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({audio:1,video:0},initializeRecorder,function(e){console.log("No live audio input: "+e)})):navigator.getUserMedia({audio:1,video:0},initializeRecorder,function(e){console.log("No live audio input: "+e)})}function initializeRecorder(e){alert("checking"),console.log("Microphone Connected");send=1,receive=1,audio_context=new AudioContext,audio_context.sampleRate,console.log("Created media stream.");var a=4096;recorder=audio_context.createScriptProcessor(a,1,1),recorder.onaudioprocess=recorderProcess,audioInput.connect(recorder),recorder.connect(audio_context.destination)}function recorderProcess(){if(e){var a=e.inputBuffer.getChannelData(0);1==send&&(ltime=(new Date).getTime(),timeSpent=1),send++,dt=JSON.stringify(a),micTimeout=setTimeout(function(){jQuery.post("/",{wordlist:dt},function(e){var a=new String(e.result),t=a.split(","),n=1e3*Math.abs(.9999-parseFloat(t[0])),r=10*parseFloat(t[1]),l=10*parseFloat(t[2]),o=10*parseFloat(t[3]);n=Math.abs(.5-r-l-o);console.log("Receive:"+receive);n=Math.random(),r=Math.random(),l=Math.random(),o=Math.random();receive++;var i=(new Date).getTime();netDelay=Math.round((i-ltime)/1e3),ltime=i,estimatedTime=netDelay*(send-receive),timeSpent+=netDelay,startProcess(n,r,l,o,timeSpent),receive<send-1&&estimatedEmotion(),document.getElementById("netDelay").innerHTML=netDelay+" sec",estimatedTime<60?document.getElementById("estimatedTime").innerHTML=estimatedTime+" secs":document.getElementById("estimatedTime").innerHTML=parseInt(estimatedTime/60)+" min "+estimatedTime%60+" secs",timeSpent<60?document.getElementById("timeSpent").innerHTML=timeSpent+" secs":document.getElementById("timeSpent").innerHTML=parseInt(timeSpent/60)+" min "+timeSpent%60+" secs",clearTimeout(micTimeout),send-1==receive?(stopProcess(),analysisFlag=!1,progressFlag=!0):progressFlag=!1},"json")},1e3)}}function stopMic(){audioInput.disconnect(recorder),recorder.disconnect(audio_context.destination),clearTimeout(micTimeout),console.log("Microphone Disconnected")}function startMicProcess(){micTimeout=setInterval(function(){var e=Math.random(),a=Math.random(),t=Math.random(),n=Math.random();timeSpent++,startProcess(e,a,t,n,timeSpent)},1e3)}function stopMicProcess(){clearInterval(micTimeout),stopProcess(),analysisFlag=!1,progressFlag=!0,document.getElementById("netDelay").innerHTML="1 sec",timeSpent<60?document.getElementById("timeSpent").innerHTML=timeSpent+" secs":document.getElementById("timeSpent").innerHTML=parseInt(timeSpent/60)+" min "+timeSpent%60+" secs",timeSpent=0}